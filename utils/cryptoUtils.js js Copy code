const axios = require('axios');

let priceCache = {};
let lastFetchTime = 0;

// Fetch real-time crypto prices from CoinGecko
const getCryptoPrice = async (crypto = 'bitcoin') => {
  const now = Date.now();
  const cryptoId = crypto.toLowerCase(); // 'bitcoin' or 'ethereum'

  // Use cache for 10 seconds
  if (priceCache[cryptoId] && (now - lastFetchTime < 10000)) {
    return priceCache[cryptoId];
  }

  try {
    const res = await axios.get(
      `https://api.coingecko.com/api/v3/simple/price?ids=${cryptoId}&vs_currencies=usd`
    );

    const price = res.data[cryptoId].usd;
    priceCache[cryptoId] = price;
    lastFetchTime = now;

    return price;
  } catch (err) {
    console.error('❌ Error fetching crypto price:', err.message);
    return priceCache[cryptoId] || 0; // fallback to last known value
  }
};

module.exports = { getCryptoPrice };
